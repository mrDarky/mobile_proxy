#:kivy 2.3.0
#:import MDCard kivymd.uix.card.MDCard
#:import MDLabel kivymd.uix.label.MDLabel
#:import MDRaisedButton kivymd.uix.button.MDRaisedButton
#:import MDFlatButton kivymd.uix.button.MDFlatButton
#:import MDIconButton kivymd.uix.button.MDIconButton
#:import MDTopAppBar kivymd.uix.toolbar.MDTopAppBar

<DeviceItem>:
    size_hint_y: None
    height: dp(100)
    padding: dp(5)
    spacing: dp(5)
    
    MDCard:
        orientation: 'horizontal'
        padding: dp(15)
        spacing: dp(10)
        elevation: 2
        radius: [10]
        md_bg_color: 0.15, 0.15, 0.2, 1
        
        BoxLayout:
            orientation: 'vertical'
            spacing: dp(5)
            
            MDLabel:
                text: root.device_name
                size_hint_y: None
                height: dp(25)
                font_style: 'H6'
                theme_text_color: 'Custom'
                text_color: 0.3, 0.7, 1, 1
                halign: 'left'
            
            MDLabel:
                text: f"Serial: {root.serial}"
                size_hint_y: None
                height: dp(20)
                font_style: 'Caption'
                theme_text_color: 'Custom'
                text_color: 0.6, 0.6, 0.6, 1
                halign: 'left'
            
            MDLabel:
                text: f"Android {root.android_version}"
                size_hint_y: None
                height: dp(20)
                font_style: 'Caption'
                theme_text_color: 'Custom'
                text_color: 0.6, 0.6, 0.6, 1
                halign: 'left'
        
        MDRaisedButton:
            text: 'Add Connection'
            size_hint: None, None
            size: dp(140), dp(40)
            md_bg_color: 0.2, 0.6, 1, 1
            pos_hint: {'center_y': 0.5}
            on_release: root.on_add_connection()

<ConnectionItem>:
    size_hint_y: None
    height: dp(120)
    padding: dp(5)
    spacing: dp(5)
    
    MDCard:
        orientation: 'horizontal'
        padding: dp(15)
        spacing: dp(10)
        elevation: 3
        radius: [10]
        md_bg_color: 0.12, 0.12, 0.18, 1
        
        BoxLayout:
            orientation: 'vertical'
            spacing: dp(5)
            
            MDLabel:
                text: f"localhost:{root.local_port} â†’ {root.serial}:{root.remote_port}"
                size_hint_y: None
                height: dp(25)
                font_style: 'Subtitle1'
                bold: True
                theme_text_color: 'Custom'
                text_color: 1, 1, 1, 1
                halign: 'left'
            
            MDLabel:
                text: f"Status: {root.status.upper()}"
                size_hint_y: None
                height: dp(22)
                font_style: 'Body2'
                bold: True
                theme_text_color: 'Custom'
                text_color: (0.3, 1, 0.3, 1) if root.status == 'active' else (1, 0.6, 0.2, 1)
                halign: 'left'
            
            MDLabel:
                text: f"IP: {root.current_ip if root.current_ip else 'Not checked'}"
                size_hint_y: None
                height: dp(20)
                font_style: 'Caption'
                theme_text_color: 'Custom'
                text_color: 0.7, 0.7, 0.7, 1
                halign: 'left'
        
        BoxLayout:
            orientation: 'vertical'
            size_hint_x: None
            width: dp(110)
            spacing: dp(5)
            
            MDRaisedButton:
                text: 'Start' if root.status == 'stopped' else 'Stop'
                size_hint_y: None
                height: dp(36)
                md_bg_color: (0.2, 0.8, 0.2, 1) if root.status == 'stopped' else (0.8, 0.2, 0.2, 1)
                on_release: root.on_toggle()
            
            MDFlatButton:
                text: 'Check IP'
                size_hint_y: None
                height: dp(36)
                theme_text_color: 'Custom'
                text_color: 0.4, 0.7, 1, 1
                on_release: root.on_check_ip()
            
            MDFlatButton:
                text: 'Change IP'
                size_hint_y: None
                height: dp(36)
                theme_text_color: 'Custom'
                text_color: 1, 0.7, 0.2, 1
                on_release: root.on_change_ip()

<MainLayout>:
    orientation: 'vertical'
    md_bg_color: 0.08, 0.08, 0.12, 1
    
    # Top toolbar
    MDTopAppBar:
        title: 'Mobile Proxy Manager'
        md_bg_color: 0.1, 0.1, 0.15, 1
        elevation: 4
        left_action_items: [['menu', lambda x: None]]
        right_action_items: [['refresh', lambda x: root.refresh_all()]]
    
    # Action buttons bar
    MDCard:
        size_hint_y: None
        height: dp(70)
        padding: dp(10)
        spacing: dp(10)
        elevation: 2
        radius: [0]
        md_bg_color: 0.1, 0.1, 0.15, 1
        
        BoxLayout:
            spacing: dp(10)
            padding: dp(5)
            
            MDRaisedButton:
                text: 'Refresh Devices'
                md_bg_color: 0.2, 0.6, 1, 1
                size_hint_x: 0.5
                pos_hint: {'center_y': 0.5}
                on_release: root.refresh_devices()
            
            MDRaisedButton:
                text: 'Refresh All'
                md_bg_color: 0.2, 0.6, 1, 1
                size_hint_x: 0.5
                pos_hint: {'center_y': 0.5}
                on_release: root.refresh_all()
    
    # Main content area
    BoxLayout:
        orientation: 'horizontal'
        spacing: dp(10)
        padding: dp(10)
        
        # Devices panel
        BoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.4
            spacing: dp(10)
            
            MDCard:
                size_hint_y: None
                height: dp(50)
                padding: dp(15), dp(10)
                elevation: 2
                radius: [10, 10, 0, 0]
                md_bg_color: 0.15, 0.15, 0.2, 1
                
                MDLabel:
                    text: 'ðŸ“± Connected Devices'
                    font_style: 'H6'
                    theme_text_color: 'Custom'
                    text_color: 0.3, 0.7, 1, 1
                    bold: True
            
            MDCard:
                elevation: 2
                radius: [0, 0, 10, 10]
                md_bg_color: 0.1, 0.1, 0.15, 1
                padding: dp(5)
                
                ScrollView:
                    BoxLayout:
                        id: device_list
                        orientation: 'vertical'
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(8)
                        padding: dp(5)
        
        # Connections panel
        BoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.6
            spacing: dp(10)
            
            MDCard:
                size_hint_y: None
                height: dp(50)
                padding: dp(15), dp(10)
                elevation: 2
                radius: [10, 10, 0, 0]
                md_bg_color: 0.15, 0.15, 0.2, 1
                
                MDLabel:
                    text: 'ðŸ”— Active Connections'
                    font_style: 'H6'
                    theme_text_color: 'Custom'
                    text_color: 0.3, 0.7, 1, 1
                    bold: True
            
            MDCard:
                elevation: 2
                radius: [0, 0, 10, 10]
                md_bg_color: 0.1, 0.1, 0.15, 1
                padding: dp(5)
                
                ScrollView:
                    BoxLayout:
                        id: connection_list
                        orientation: 'vertical'
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(8)
                        padding: dp(5)
